# 核心匹配系統使用指南 v4.0

> 🏆 **革命性升級** - 整合版匹配系統，96.54%匹配率，零資料遺失

## 📋 目錄

- [v4.0重大更新](#v40重大更新)
- [系統概述](#系統概述)
- [匹配策略詳解](#匹配策略詳解)
- [快速開始](#快速開始)
- [輸出說明](#輸出說明)
- [QGIS整合](#qgis整合)
- [故障排除](#故障排除)

## v4.0重大更新

### 🎯 核心改進

#### **匹配策略革新**
- **移除隨機座標填充**：未匹配資料座標填 NA，不再使用隨機值
- **雙重匹配策略**：道路匹配 + 村里匹配，最大化利用門牌資源
- **智能資源利用**：28.6% 道路門牌 + 66.8% 村里門牌 = 完整覆蓋

#### **資料完整性保證**
- **零資料遺失**：保留所有原始診所資料
- **雙輸出格式**：地址資訊檔 + 完整資料檔
- **完整驗證機制**：自動檢查結果品質

#### **實戰驗證結果**
```
📊 嘉義縣318筆診所實測：
✅ 匹配率：96.54% (307/318)
✅ 高品質匹配：77.5% (道路精確)
✅ 中等品質匹配：2.9% (道路部分)  
✅ 一般品質匹配：19.5% (村里)
✅ 零資料遺失：100%保留
```

## 系統概述

### 🏆 核心特色

#### **匹配精度分級**
| 等級 | 匹配方式 | 精度說明 | 適用場景 |
|------|----------|----------|----------|
| 🟢 高 | 道路精確匹配 | 街道名稱完全吻合 | 精確定位分析 |
| 🟡 中等 | 道路部分匹配 | 去段號後匹配成功 | 一般地理分析 |
| 🟠 一般 | 村里匹配 | 行政區域級定位 | 區域性分析 |
| ⚪ 未匹配 | 座標填NA | 保留原始資料 | 人工後處理 |

#### **技術優勢**
- **智能門牌利用**：65,358筆道路門牌 + 131,611筆村里門牌
- **TWD97座標系統**：台灣官方標準，QGIS直接相容
- **記憶體優化**：批次處理，穩定可靠
- **完整可追蹤性**：每筆資料處理狀態完整記錄

## 匹配策略詳解

### 🎯 三層匹配策略

#### **第一層：道路精確匹配**
```r
# 策略：診所道路名稱 ⟷ 門牌道路名稱
診所："中山路" ↔ 門牌："中山路" ✅ 匹配成功
```
- **匹配條件**：道路名稱完全相同
- **精度等級**：🟢 高精度
- **預期匹配率**：75-80%
- **座標精度**：街道級（10-50公尺）

#### **第二層：道路部分匹配**
```r
# 策略：移除段號後匹配
診所："中山路一段" → "中山路" ↔ 門牌："中山路" ✅ 匹配成功
```
- **匹配條件**：去除段號後名稱相同
- **精度等級**：🟡 中等精度  
- **預期匹配率**：2-5%
- **座標精度**：道路級（50-200公尺）

#### **第三層：村里匹配**
```r
# 策略：行政區域匹配
診所村里："安仁里" ↔ 門牌村里："安仁里" ✅ 匹配成功
```
- **匹配條件**：村里名稱相同
- **精度等級**：🟠 一般精度
- **預期匹配率**：15-25%
- **座標精度**：村里級（200-1000公尺）

### 📊 門牌資源利用策略

#### **資源分布分析**
```
嘉義縣門牌資料：196,971筆
├── 有道路名稱：65,358筆 (33.2%) → 道路匹配
├── 無道路有村里：131,611筆 (66.8%) → 村里匹配  
└── 無任何資訊：2筆 (0.01%) → 無法利用
```

#### **匹配覆蓋率**
- **道路覆蓋**：510條唯一道路
- **村里覆蓋**：326個村里
- **空間覆蓋**：嘉義縣全境
- **總利用率**：99.99%

### 🚫 v4.0移除的問題策略

#### **隨機區域匹配（已移除）**
```r
# v3.0 問題策略（已移除）
❌ 隨機分配座標：多個診所 → 相同隨機座標
❌ 循環座標分配：172815.5, 2595369 重複出現
❌ 誤導性結果：假的精確度
```

#### **移除原因**
1. **除錯困難**：隨機座標讓驗證變得困難
2. **結果不實**：虛假的高匹配率
3. **後續問題**：影響空間分析準確性

## 快速開始

### 前置準備

1. **環境檢查**
```r
# 檢查R版本（需要4.0以上）
R.version.string

# 安裝必要套件
install.packages(c("dplyr", "stringr"))
library(dplyr)
library(stringr)
```

2. **資料準備**
確保您的診所資料包含以下欄位：
- `醫事機構名稱` - 診所名稱
- `街_路段` - 道路名稱（如有）
- `村里` - 村里名稱（如有）
- `地區` - 鄉鎮市區

3. **門牌資料集**
```r
# 檢查可用的門牌資料集
available_datasets <- ls(pattern = "housenumber")
print(available_datasets)

# 嘉義縣範例
if("Chiayi_County_housenumber" %in% available_datasets) {
    cat("✅ 嘉義縣門牌資料已載入\n")
}
```

### 一鍵執行

```r
# 載入整合版匹配系統
source("R/core_matching_system.R")

# 🚀 一鍵執行（推薦）
final_results <- run_integrated_matching(
    "Chiayi_County_clinic", 
    "Chiayi_County_housenumber"
)

# 查看結果摘要
print(final_results$stats)
```

**就這麼簡單！** 🎉

## 輸出說明

### 雙檔案輸出格式

#### **檔案1：地址資訊檔**
```
整合版TWD97診所匹配_地址資訊_YYYYMMDD_HHMM.csv
```

**用途**：GIS分析和地理視覺化
**欄位**：
- `醫事機構名稱` - 診所名稱
- `地址` - 原始地址
- `診所地區` - 鄉鎮市區
- `診所村里` - 村里名稱
- `診所道路` - 道路名稱
- `匹配狀態` - "匹配成功" 或 "未匹配"
- `匹配方式` - "道路精確匹配"/"道路部分匹配"/"村里匹配"
- `匹配品質` - "高"/"中等"/"一般"
- `TWD97_X` - TWD97橫座標（未匹配為NA）
- `TWD97_Y` - TWD97縱座標（未匹配為NA）
- `未匹配原因` - 詳細原因說明

#### **檔案2：完整資料檔**
```
整合版TWD97診所匹配_完整資料_YYYYMMDD_HHMM.csv
```

**用途**：完整資料分析和後續處理
**特色**：
- 保留所有原始欄位
- 在後方添加匹配結果欄位
- 適合完整的業務分析

### 統計報告範例

```
=== 整合匹配結果統計 ===
診所總數: 318 筆
匹配成功: 307 筆
未匹配: 11 筆
整體匹配率: 96.54 %

📊 匹配方式統計:
      匹配方式 匹配品質   n 比例
1 道路精確匹配       高 238 77.5
2     村里匹配     一般  60 19.5
3 道路部分匹配     中等   9  2.9

📊 未匹配原因統計:
          未匹配原因 n 比例
1     村里無對應門牌 5 45.5
2   無道路和村里資訊 3 27.3
3 道路名稱無對應門牌 3 27.3

📍 座標範圍:
X座標: 162576.7 ~ 219721 
Y座標: 2577418 ~ 2611445 
✅ 座標範圍符合TWD97格式
```

## QGIS整合

### 基本匯入

1. **開啟QGIS**
2. **載入資料**
   - 圖層 → 新增圖層 → 新增分隔文字圖層
   - 選擇：`整合版TWD97診所匹配_地址資訊_YYYYMMDD_HHMM.csv`

3. **座標設定**
   - X欄位：`TWD97_X`
   - Y欄位：`TWD97_Y`
   - 幾何CRS：`EPSG:3826` (TWD97 / TM2 zone 121)

4. **篩選有座標的診所**
   ```sql
   "匹配狀態" = '匹配成功'
   ```

### 進階視覺化

#### **依匹配品質分色顯示**
在圖層屬性 → 符號系統 → 分類渲染器：

| 匹配品質 | 顏色 | 符號大小 | 說明 |
|----------|------|----------|------|
| 高 | 🟢 綠色 | 大 | 道路精確匹配 |
| 中等 | 🟡 黃色 | 中 | 道路部分匹配 |
| 一般 | 🟠 橙色 | 小 | 村里匹配 |

#### **表達式範例**
```sql
-- 依匹配品質調整符號大小
CASE 
    WHEN "匹配品質" = '高' THEN 8
    WHEN "匹配品質" = '中等' THEN 6
    WHEN "匹配品質" = '一般' THEN 4
    ELSE 2
END

-- 依匹配方式設定標籤
CASE 
    WHEN "匹配方式" = '道路精確匹配' THEN '精確'
    WHEN "匹配方式" = '道路部分匹配' THEN '部分'
    WHEN "匹配方式" = '村里匹配' THEN '區域'
    ELSE '未匹配'
END
```

## 故障排除

### 常見問題

#### 1. 匹配率過低（<80%）

**可能原因**：
- 診所資料缺少道路或村里資訊
- 門牌資料覆蓋不足
- 地址格式不標準

**診斷步驟**：
```r
# 檢查診所地址資訊完整性
clinic_info <- clinic %>%
    summarise(
        有街_路段 = sum(!is.na(街_路段) & 街_路段 != ""),
        有村里 = sum(!is.na(村里) & 村里 != ""),
        無定位資訊 = sum((is.na(街_路段) | 街_路段 == "") & 
                       (is.na(村里) | 村里 == "")),
        總數 = n()
    )

print(clinic_info)

# 檢查門牌資料品質
housenumber_info <- housenumber_data %>%
    summarise(
        有街道 = sum(!is.na(`街.路段`) & `街.路段` != ""),
        有村里 = sum(!is.na(村里) & 村里 != ""),
        總數 = n()
    )

print(housenumber_info)
```

#### 2. 村里匹配失效

**症狀**：道路匹配正常，但村里匹配為0

**檢查方法**：
```r
# 檢查村里欄位是否存在
if("村里" %in% colnames(clinic_data)) {
    cat("✅ 診所資料有村里欄位\n")
} else {
    cat("❌ 診所資料缺少村里欄位\n")
}

if("村里" %in% colnames(housenumber_data)) {
    cat("✅ 門牌資料有村里欄位\n")
} else {
    cat("❌ 門牌資料缺少村里欄位\n")
}

# 檢查村里資料品質
clinic_villages <- clinic_data %>%
    filter(!is.na(村里) & 村里 != "") %>%
    count(村里, sort = TRUE)

housenumber_villages <- housenumber_data %>%
    filter(!is.na(村里) & 村里 != "") %>%
    count(村里, sort = TRUE)

# 檢查重疊的村里
common_villages <- intersect(clinic_villages$村里, housenumber_villages$村里)
cat("共同村里數量:", length(common_villages), "\n")
```

#### 3. 座標範圍異常

**檢查TWD97座標合理性**：
```r
# 檢查座標範圍
if(!is.null(final_results$complete_data)) {
    coord_check <- final_results$complete_data %>%
        filter(!is.na(TWD97_X), !is.na(TWD97_Y)) %>%
        summarise(
            X_min = min(TWD97_X), X_max = max(TWD97_X),
            Y_min = min(TWD97_Y), Y_max = max(TWD97_Y),
            count = n()
        )
    
    print(coord_check)
    
    # TWD97台灣範圍檢查
    if(coord_check$X_min > 100000 && coord_check$X_max < 400000 &&
       coord_check$Y_min > 2000000 && coord_check$Y_max < 3000000) {
        cat("✅ 座標範圍正常\n")
    } else {
        cat("❌ 座標範圍異常，請檢查\n")
    }
}
```

### 最佳實務

#### **資料準備建議**

1. **診所資料品質檢查**
```r
# 檢查關鍵欄位完整性
quality_check <- clinic %>%
    summarise(
        醫事機構名稱_完整率 = round(sum(!is.na(醫事機構名稱))/n()*100, 1),
        街_路段_完整率 = round(sum(!is.na(街_路段) & 街_路段 != "")/n()*100, 1),
        村里_完整率 = round(sum(!is.na(村里) & 村里 != "")/n()*100, 1),
        地區_完整率 = round(sum(!is.na(地區) & 地區 != "")/n()*100, 1)
    )

print(quality_check)
```

2. **匹配策略選擇**
- **街_路段完整率 > 70%**：可獲得高匹配率
- **村里完整率 > 80%**：村里匹配效果佳
- **兩者都低**：考慮其他地理編碼方案

#### **效能優化**
```r
# 大量資料處理建議
if(nrow(clinic) > 10000) {
    cat("建議使用以下優化設置：\n")
    cat("- 確保充足記憶體 (16GB+)\n") 
    cat("- 適當的批次大小設定\n")
    cat("- 定期清理記憶體\n")
}
```

---

## 總結

v4.0 整合版匹配系統代表了地址匹配技術的重大進步：

✅ **96.54% 匹配率** - 業界領先水準  
✅ **零資料遺失** - 完整保留所有診所  
✅ **品質分級** - 三層精度等級  
✅ **智能資源利用** - 最大化門牌資料價值  
✅ **即用即開** - 一鍵執行，雙檔案輸出  

**立即開始使用，體驗突破性的地址匹配技術！** 🚀